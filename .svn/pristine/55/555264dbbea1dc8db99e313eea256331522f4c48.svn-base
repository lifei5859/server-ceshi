const Koa = require('koa');
const Router = require('koa-router');
const static = require('koa-static');
const send = require('koa-send');
const body=require('koa-better-body');
const koaBody = require('koa-bodyparser')
const path = require('path')
const session = require('koa-session')
let server = new Koa();
server.listen(10086);

// server.use(koaBody());
server.use(body({
    uploadDir: './pages/upload/'
}));
server.keys = [
    'asdfa454df56a4sd5f4a5sd6f',
    'ad4f56as4d6f54asd65f4a6s5d4f',
    'a5sd4f65a4sdf654asd6f54a6sd5f'
]

let router = new Router();
server.use(session({
    maxAge: 20*60*1000,   //有效期
    renew: true,
    httpOnly: false         //自动续期
  }, server));
router.get('/a', (ctx) => {
    
        let {a, b} = ctx.query
        console.log(a, b)
        // if (!b) {
        //     ctx.throw(500, '我错了')
        // }
        ctx.assert(a, 401, 'a is required')
        ctx.body = 'woca';
 
});
let data = '';
router.all('*', async (ctx, next) => {
    ctx.cookies.set('user', 'wocao', {signed: true, overwirte: "true", httpOnly: false})
    console.log(ctx.cookies.get('user'))
    ctx.session['viwe'] = 'aiyou'
    await next()
})
router.post('/up', async (ctx) => {
    // console.log(ctx.request.files)
    console.log(ctx.method)
    console.log(ctx.request.fields)
    data = ctx.request.fields.f1[0].path
    // there's no `.body` when `multipart`,
    // `urlencoded` or `json` request
    // console.log(ctx.request.body)
    ctx.body = 'ojbk'
})
router.get('/download/:name', async (ctx) => {
    const name = ctx.params.name;
    const path = `upload/${name}`;
    ctx.attachment(path);
    await send(ctx, path);
})
router.get('/getimg', async ctx => {
    console.log(data)
    ctx.body = data;
})
// router.get('/pages/upload/:id', async (ctx) => {
//     const name = ctx.params.name;
//     const path = `pages/upload/${name}`;
//     console.log(name)
//     ctx.attachment(path);
//     await send(ctx, path);
// })
server.use(router.routes())
// server.use(staticFiles(path.join(__dirname + './pages/')))
server.use(static('./pages', {
    index: 'index.html',
    maxAge: 1000000
}))
// server.use(async ctx => {
//     ctx.cookies.set('user', 'wocao', {})
// })