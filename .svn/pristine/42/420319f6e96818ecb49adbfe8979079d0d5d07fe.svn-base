const Router = require('koa-router');
const path = require('path');
const fs = require('await-fs');
const common = require('../../libs/common');
const {PASS_SUFFIX, HTTP_HOST} = require('../../config')

let router = new Router();

router.get('/login', async ctx => {
    await ctx.render('admin/login', {
        HTTP_HOST,
    });
});

router.post('/login', async ctx => {
    let {user, password} = ctx.request.fields
    let data = await fs.readFile(path.resolve(__dirname, '../../static/admin.json'));
    let adminArr = JSON.parse(data);
    ctx.assert(user, 400, 'user is required');
    ctx.assert(password, 400, 'password is required');
    let tempAdmin = adminArr.filter(item => {
        return (item.name === user);
    });
    if (tempAdmin.length === 0) {
        ctx.body = common.resJson(0, '用户不存在');
        return;
    }
    if (tempAdmin[0].pass !== common.md5(password + PASS_SUFFIX)) {
        ctx.body = common.resJson(0, '密码错误');
        return;
    }
    ctx.session['admin'] = user;
    ctx.body = common.resJson(1, '登录成功');
})
router.all('*', async (ctx, next) => {
    if (ctx.session['admin']) {
       await next();
        // return;
    } else {
        ctx.redirect('admin/login');
    }
});

const tableConf = [
    {title: '标题', name: 'title', type: 'text'},
    {title: '图片', name: 'src', type: 'file'},
    {title: '链接', name: 'href', type: 'text'},
    {title: '序号', name: 'serial', type: 'number'}
];

router.get('/', async ctx => {
    try {
        await ctx.render('admin/index', {
        title: 'banner编辑',
        tableConf
        });
    } catch (e) {
        console.log(e)
        ctx.body = { err: 1, msg: 'server error' }
    }
});



module.exports = router.routes()